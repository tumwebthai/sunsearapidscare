import Anthropic from '@anthropic-ai/sdk'
import { supabaseAdmin } from '@/lib/supabase-admin'

const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY })

/* ‚îÄ‚îÄ Cached DB data (5 min TTL) ‚îÄ‚îÄ */
interface CachedData {
  vehicles: { name: string; name_en: string; seats: number; luggage: number; price_per_day: number; category: string }[]
  routes: { name: string; name_en: string; airport: string; duration: string; sedan_price: number; van_price: number }[]
  settings: Record<string, string>
  fetchedAt: number
}

let cache: CachedData | null = null
const CACHE_TTL = 5 * 60 * 1000 // 5 minutes

async function getCachedData(): Promise<CachedData> {
  if (cache && Date.now() - cache.fetchedAt < CACHE_TTL) return cache

  const [vehiclesRes, routesRes, settingsRes] = await Promise.all([
    supabaseAdmin.from('vehicles').select('name, name_en, seats, luggage, price_per_day, category').eq('is_active', true),
    supabaseAdmin.from('routes').select('name, name_en, airport, duration, price_sedan, price_van').eq('is_active', true),
    supabaseAdmin.from('site_settings').select('key, value'),
  ])

  const settings: Record<string, string> = {}
  for (const row of settingsRes.data || []) {
    if (row.value) settings[row.key] = row.value
  }

  cache = {
    vehicles: (vehiclesRes.data || []).map((v) => ({
      name: v.name || '',
      name_en: v.name_en || '',
      seats: v.seats || 0,
      luggage: v.luggage || 0,
      price_per_day: v.price_per_day || 0,
      category: v.category || '',
    })),
    routes: (routesRes.data || []).map((r) => ({
      name: r.name || '',
      name_en: r.name_en || '',
      airport: r.airport || '',
      duration: r.duration || '',
      sedan_price: r.price_sedan || 0,
      van_price: r.price_van || 0,
    })),
    settings,
    fetchedAt: Date.now(),
  }

  return cache
}

function buildSystemPrompt(data: CachedData): string {
  const { vehicles, routes, settings } = data

  const vehicleList = vehicles.length > 0
    ? vehicles.map((v) => `- ${v.name} (${v.name_en}) ‚Äî ${v.seats} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, ${v.luggage} ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ ${v.price_per_day.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô`).join('\n')
    : '- Toyota Commuter VIP ‚Äî 9 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, 9 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ 3,000 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô\n- Toyota Commuter Standard ‚Äî 13 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, 10 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ 1,800 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô\n- Hyundai H1 VIP ‚Äî 5 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, 4 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ 2,500 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô\n- Toyota Alphard Executive ‚Äî 4 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, 3 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ 4,500 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô\n- Toyota Majesty Premium ‚Äî 7 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, 5 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ 3,500 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô\n- Hyundai Staria Luxury ‚Äî 7 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á, 5 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤ 3,500 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô'

  const routeList = routes.length > 0
    ? routes.map((r) => `- ${r.name}: Sedan ${r.sedan_price.toLocaleString()} ‡∏ö‡∏≤‡∏ó / Van ${r.van_price.toLocaleString()} ‡∏ö‡∏≤‡∏ó (~${r.duration})`).join('\n')
    : '- ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥ ‚Üí ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û: Sedan 1,200 ‡∏ö‡∏≤‡∏ó / Van 1,800 ‡∏ö‡∏≤‡∏ó (~45 ‡∏ô‡∏≤‡∏ó‡∏µ)\n- ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥ ‚Üí ‡∏û‡∏±‡∏ó‡∏¢‡∏≤: Sedan 2,000 ‡∏ö‡∏≤‡∏ó / Van 2,800 ‡∏ö‡∏≤‡∏ó (~2 ‡∏ä‡∏°.)\n- ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥ ‚Üí ‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô: Sedan 3,000 ‡∏ö‡∏≤‡∏ó / Van 4,000 ‡∏ö‡∏≤‡∏ó (~3 ‡∏ä‡∏°.)\n- ‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‚Üí ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û: Sedan 1,000 ‡∏ö‡∏≤‡∏ó / Van 1,500 ‡∏ö‡∏≤‡∏ó (~40 ‡∏ô‡∏≤‡∏ó‡∏µ)'

  const phone = settings.phone_number || '084-289-4662'
  const lineId = settings.line_id || '@sunsearapidscare'
  const lineUrl = settings.line_url || 'https://lin.ee/Wg7UFYw'
  const facebookUrl = settings.facebook_url || ''
  const email = settings.email || 'info@sunsearapidscare.com'

  return `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏ã‡∏ô" (San) ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á SunSeaRapidsCare ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ‡∏ï‡∏π‡πâ VIP ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢

## ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
- ‡∏ä‡∏∑‡πà‡∏≠: SunSeaRapidsCare (‡∏ã‡∏±‡∏ô‡∏ã‡∏µ‡∏£‡∏≤‡∏õ‡∏¥‡∏î‡∏™‡πå‡πÅ‡∏Ñ‡∏£‡πå)
- ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ‡∏ï‡∏π‡πâ VIP ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö, ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô, ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏ó‡∏¢
- ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${phone}
- LINE: ${lineId} (${lineUrl})
${facebookUrl ? `- Facebook: ${facebookUrl}` : ''}- Email: ${email}
- ‡πÄ‡∏ß‡πá‡∏ö: sunsearapidscare.com

## ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
${vehicleList}

## ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô
${routeList}

## ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
- ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° Service Mind
- ‡∏£‡∏ñ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
- ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á + GPS Tracking
- ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 15-20 ‡∏ô‡∏≤‡∏ó‡∏µ
- ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏ñ‡∏π‡∏Å‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á

## ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
- ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
- ‡∏°‡∏±‡∏î‡∏à‡∏≥ 30% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
- ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ü‡∏£‡∏µ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

## ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö ‚Äî ‡∏ï‡∏≠‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏ä‡∏ó LINE ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà robot

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

‡∏Å‡∏é:
- ‡∏ï‡∏≠‡∏ö 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà bullet points, ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, ‡∏î‡∏≤‡∏ß (‚òÖ), ‡∏´‡∏£‡∏∑‡∏≠ markdown formatting (**bold**) ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ß ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡∏¥‡∏î
- ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏ä‡πâ "‡∏Ñ‡πà‡∏∞" "‡∏ô‡∏∞‡∏Ñ‡∏∞" "‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞" ‡∏ï‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
- ‡πÉ‡∏ä‡πâ emoji ‡πÅ‡∏Ñ‡πà 1-2 ‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
- ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‚Üí ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô, ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏¢‡∏≤‡∏ß ‚Üí ‡∏ï‡∏≠‡∏ö‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÅ‡∏ï‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏™‡∏ô‡∏∏‡∏Å
- ‡∏†‡∏≤‡∏©‡∏≤: ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏° (‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏à‡∏µ‡∏ô/‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô/‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ)

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ:
- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡∏°‡∏µ‡∏£‡∏ñ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á" ‚Üí "‡∏°‡∏µ‡∏£‡∏ñ‡∏ï‡∏π‡πâ VIP 6 ‡∏Ñ‡∏±‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 4-10 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ‡∏£‡∏≤‡∏Ñ‡∏≤ 1,800-5,500 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô‡∏Ñ‡∏∞ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÄ‡∏•‡∏¢ üòä"
- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏õ‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà" ‚Üí "‡πÑ‡∏õ‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á? üôÇ"
- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥" ‚Üí "‡∏£‡∏ñ Sedan 1,200 ‡∏ö‡∏≤‡∏ó ‡∏£‡∏ñ‡∏ï‡∏π‡πâ VIP 1,800 ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 45-60 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏™‡∏ô‡πÉ‡∏à‡∏à‡∏≠‡∏á‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞? üöê"
- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡∏à‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á" ‚Üí "‡∏à‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ sunsearapidscare.com/booking ‡πÅ‡∏Ñ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞ üôè"
- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "hello" ‚Üí "Hi! Welcome to SunSeaRapidsCare üòä How can I help you? Airport transfer or daily van rental?"

‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î:
- ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏ï‡∏Å‡∏•‡∏á‡∏Ñ‡πà‡∏∞!" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞!" ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏ö‡∏ö üöê **‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏ñ** ‚Äî ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ "‚Üí" ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
- ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:
- ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î/‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô "‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞? üòä"
- ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Üí ‡∏ï‡∏≠‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ä‡∏ß‡∏ô‡∏à‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞
- ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‚Üí ‡∏ï‡∏≠‡∏ö‡πÅ‡∏Ñ‡πà 2-3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏ß‡∏ô‡∏à‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠ ‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`
}

interface ChatMessage {
  role: 'user' | 'assistant'
  content: string
}

interface AIResponseResult {
  response: string
  inputTokens: number
  outputTokens: number
}

export async function generateAIResponse({
  message,
  history,
}: {
  message: string
  history: ChatMessage[]
  sessionId: string
}): Promise<AIResponseResult> {
  try {
    const data = await getCachedData()
    const systemPrompt = buildSystemPrompt(data)

    const messages: { role: 'user' | 'assistant'; content: string }[] = [
      ...history,
      { role: 'user' as const, content: message },
    ]

    const result = await client.messages.create({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 500,
      temperature: 0.7,
      system: systemPrompt,
      messages,
    })

    const textBlock = result.content.find((b) => b.type === 'text')
    const response = textBlock ? textBlock.text : '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ üôè'

    return {
      response,
      inputTokens: result.usage.input_tokens,
      outputTokens: result.usage.output_tokens,
    }
  } catch (err) {
    console.error('AI Engine error:', err)
    const data = await getCachedData().catch(() => null)
    const lineId = data?.settings?.line_id || '@sunsearapidscare'
    return {
      response: `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE ${lineId} ‡∏Ñ‡πà‡∏∞ üôè`,
      inputTokens: 0,
      outputTokens: 0,
    }
  }
}
